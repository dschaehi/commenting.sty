%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% commenting.sty (https://github.com/dschaehi/commenting.sty)
%
% Collaborative academic writing support:
%   - Tracked author-tagged insertions
%   - Inline (in-text) reviewer / author comments
%   - Footnote-style comments (separate stream, alphabetic, colorized)
%   - Multi-line inline & footnote comment environments
%   - Author-colored block environments (highlighted paragraphs)
%   - Draft / final mode switch (all markup suppressed in final)
%   - Colorblind-safe palette (ten distinct hues)
%   - Minimal keystroke cost: per-author macro namespace (\alice, \alicei, \alicef, etc.)
%
% Design goals:
%   * Zero output artifacts in final mode
%   * Robustness in moving arguments (footnotes / section titles) via \DeclareRobustCommand
%   * Accessibility: palette chosen for distinguishability under common CVD types
%   * Low coupling: no redefinition of LaTeX core user-facing macros
%
% Quick Start:
%   \usepackage[draft]{commenting}
%   \registerauthor{alice}[Alice][cbBlue]
%   \registerauthor{bob}[Bob][cbOrange]
%   Some \alice{added text}. \alicei{Inline note} \bobf{Footnote note}
%
% Generated per author X:
%   \X{<text>}        Added text (colored + superscript signature in draft; plain in final)
%   \Xdel{<text>}     Deleted text (colored strikethrough + signature in draft; hidden in final)
%   \Xi{<comment>}    Inline comment (draft only)
%   \Xf{<comment>}    Footnote comment (draft only, alphabetic marker)
%   \begin{Xenv} ... \end{Xenv}    Colored paragraph environment (draft only margin signature)
%   \begin{Xienv} ... \end{Xienv}  Multi-line inline comment (draft only)
%   \begin{Xfenv} ... \end{Xfenv}  Multi-line footnote comment (draft only)
%
% Version History:
%   v2.1 (2025/08/06)  Documentation improvements; metadata sync
%   v2.0 (2025/01/21)  Refactor & robust command declarations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{commenting}[2025/08/06 v2.1 by Jae Hee Lee (http://jaeheelee.de)]

% Package options and draft mode handling
\RequirePackage{ifthen}
\newboolean{isDraft}

% First set default based on document class
\@ifclasswith{article}{draft}{\setboolean{isDraft}{true}}{\setboolean{isDraft}{false}}

% Then let package options override
\DeclareOption{draft}{\setboolean{isDraft}{true}}
\DeclareOption{final}{\setboolean{isDraft}{false}}
\ProcessOptions\relax


% Required packages
\RequirePackage[T1]{fontenc}          % For proper font encoding
\RequirePackage[ruled,perpage]{manyfoot} % For multiple footnote styles
\RequirePackage{xcolor}               % For colored text
\RequirePackage{hyperref}             % For hyperlinks
\AtEndPreamble{\hypersetup{draft=false}} % Disable hyperref draft mode
\RequirePackage[normalem]{ulem}       % For strikethrough (normalem preserves \emph)

% Required packages for optional arguments and hooks
\RequirePackage{xparse}
\RequirePackage{etoolbox}
\RequirePackage{environ}              % For capturing environment content
\RequirePackage{graphicx}
\ifthenelse{\boolean{isDraft}}{\setkeys{Gin}{draft=false}}

% Extract first author from \author command
\newcommand{\getfirstauthor}{%
    \ifcsname @author\endcsname
        \expandafter\getfirstauthorhelper\expandafter{\@author}%
    \else
        % Empty if \author is undefined
        {}%
    \fi
}
\newcommand{\getfirstauthorhelper}[1]{%
    \expandafter\getfirstword#1 \@nil
}
\def\getfirstword#1 #2\@nil{#1}

% Colorblind-safe color palette
% These colors are chosen for maximum distinguishability for all types of color vision
% Source: Based on ColorBrewer and research on colorblind-safe palettes
\definecolor{cbBlue}{RGB}{51,114,189}       % Strong blue
\definecolor{cbOrange}{RGB}{255,127,42}     % Vivid orange
\definecolor{cbTeal}{RGB}{64,204,204}       % Bright teal
\definecolor{cbRed}{RGB}{217,37,37}         % Clear red
\definecolor{cbPurple}{RGB}{148,103,189}    % Muted purple
\definecolor{cbGreen}{RGB}{0,158,115}       % Bright green
\definecolor{cbYellow}{RGB}{240,228,66}     % Vivid yellow
\definecolor{cbPink}{RGB}{204,121,167}      % Soft pink
\definecolor{cbBrown}{RGB}{146,73,0}        % Warm brown
\definecolor{cbGray}{RGB}{128,128,128}      % Neutral gray

% Define signature command for author identification
\newcommand{\signature}[1]{\textsuperscript{\textsf{#1}}}

% Setup custom footnote style with alphabetic symbols in red
\DeclareNewFootnote{A}[fnsymbol]
\renewcommand{\thefootnoteA}{\textcolor{red}{\alph{footnoteA}}}

% Fix hyperref compatibility with manyfoot
\@ifpackageloaded{hyperref}{%
    \renewcommand{\footnoteA}[1]{%
        \stepcounter{footnoteA}%
        \protected@xdef\@thefnmark{\thefootnoteA}%
        \hyper@makecurrent{footnoteA}%
        \@footnotemark%
        \@footnotetext{#1}%
    }%
}{}

% Command for footnote-style comments
% Args: #1=author identifier, #2=color, #3=comment text
\newcommand{\footnotecommentFragile}[3]{%
    \ifthenelse{\boolean{isDraft}}%
    {\protect{\color{#2}\footnoteA{\color{#2}\guillemotright#3\guillemotleft\signature{#1}}}}%
    {}%
}
\DeclareRobustCommand{\footnotecomment}[3]{\footnotecommentFragile{#1}{#2}{#3}}

% Command for inline comments
% Args: #1=author identifier, #2=color, #3=comment text
\newcommand{\inlinecommentFragile}[3]{%
    \ifthenelse{\boolean{isDraft}}%
    {{\noindent\small\leavevmode\color{#2}\guillemotright#3\guillemotleft\signature{#1}}}%
    {\noindent\unskip}%
}
\DeclareRobustCommand{\inlinecomment}[3]{\inlinecommentFragile{#1}{#2}{#3}}


% Command for added text with author attribution
% Args: #1=author identifier, #2=color, #3=added text
\newcommand{\addedFragile}[3]{{%
            \ifthenelse{\boolean{isDraft}}
            {\leavevmode\color{#2}#3\signature{#1}}
            {#3}}%
}
\DeclareRobustCommand{\added}[3]{\addedFragile{#1}{#2}{#3}}

% Command for deleted text with author attribution
% Args: #1=author identifier, #2=color, #3=deleted text
\newcommand{\deletedFragile}[3]{{%
            \ifthenelse{\boolean{isDraft}}
            {\leavevmode\color{black!30!white}\sout{#3}\signature{#1}}
            {}}%
}
\DeclareRobustCommand{\deleted}[3]{\deletedFragile{#1}{#2}{#3}}


% Environment for colored text blocks with margin notes
% Args: #1=color, #2=author identifier
\newenvironment{colored}[2]
{\ifhmode\par\fi\ifthenelse{\boolean{isDraft}}{\color{#1}\marginpar{\vspace*{\baselineskip}\signature{#2}}}{}}
{\ifthenelse{\boolean{isDraft}}{}{}}

% Register a new author with associated commands
% Args:
% #1 (mandatory) = command identifier (e.g., alice for \alice commands)
% [#2] (optional) = display name (defaults to first word in \author or empty; use "none" to hide signature)
% [#3] (optional) = color name (defaults to cbRed)
\NewDocumentCommand{\registerauthor}{m o o}{%
    % Create author-specific variables to avoid overwrites
    % Get author name - use optional arg if provided, else first author, else empty
    % Special handling: if #2 is "none", set display name to empty
    \IfNoValueTF{#2}
    {\expandafter\def\csname displayname@#1\endcsname{\getfirstauthor}}
    {\def\tempauthorname{#2}%
        \def\tempnone{none}%
        \ifx\tempauthorname\tempnone
            \expandafter\def\csname displayname@#1\endcsname{}%
        \else
            \expandafter\def\csname displayname@#1\endcsname{#2}%
        \fi}%

    % Get color - use optional arg if provided, else cbRed
    \IfNoValueTF{#3}
    {\expandafter\def\csname authorcolor@#1\endcsname{cbRed}}
    {\expandafter\def\csname authorcolor@#1\endcsname{#3}}%

    % Define color using author-specific color name
    \expandafter\definecolor{color#1}{named}{\csname authorcolor@#1\endcsname}%

    % Define commands using command identifier and author-specific display name
    \expandafter\newcommand\csname #1i\endcsname[1]{%
        \inlinecomment{\csname displayname@#1\endcsname}{color#1}{##1}}%
    \expandafter\newcommand\csname #1f\endcsname[1]{%
        \footnotecomment{\csname displayname@#1\endcsname}{color#1}{##1}}%
    \expandafter\newcommand\csname #1\endcsname[1]{%
        \added{\csname displayname@#1\endcsname}{color#1}{##1}}%
    \expandafter\newcommand\csname #1del\endcsname[1]{%
        \deleted{\csname displayname@#1\endcsname}{color#1}{##1}}%
    \expandafter\newenvironment{#1env}{%
        \begin{colored}{color#1}{\csname displayname@#1\endcsname}}%
            {\end{colored}}%

    % Add environment versions of inline and footnote comments
    % We need to use \csname and \endcsname correctly with NewEnviron
    \expandafter\newcommand\expandafter{\csname create#1ienv\endcsname}{%
        \NewEnviron{#1ienv}{%
            \ifthenelse{\boolean{isDraft}}%
            {\noindent\small\leavevmode\color{color#1}\guillemotright\BODY\guillemotleft\signature{\csname displayname@#1\endcsname}}%
            {}% In final mode, discard content
        }[]%
    }%
    \csname create#1ienv\endcsname

    \expandafter\newcommand\expandafter{\csname create#1fenv\endcsname}{%
        \NewEnviron{#1fenv}{%
            \ifthenelse{\boolean{isDraft}}%
            {\footnoteA{\color{color#1}\guillemotright\BODY\guillemotleft\signature{\csname displayname@#1\endcsname}}}%
            {}% In final mode, discard content
        }[]%
    }%
    \csname create#1fenv\endcsname
}